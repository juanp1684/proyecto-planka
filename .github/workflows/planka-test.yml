name: CI Pruebas REST PLANKA
on:
  push:
    branches: 
    - main 
    - daniela
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          docker compose down -v  # Borra contenedores y volÃºmenes (db-data incluido)
          docker compose up -d

      - name: Set environment variables for tests
        run: |
          echo "BASE_URI=http://localhost:3000" >> $GITHUB_ENV
          echo "USER_EMAIL=${{ secrets.USER_EMAIL }}" >> $GITHUB_ENV
          echo "USER_PASSWORD=${{ secrets.USER_PASSWORD }}" >> $GITHUB_ENV

      - name: Wait for Planka to be ready
        run: |
          echo "Esperando Planka..."
          until $(curl --output /dev/null --silent --head --fail http://localhost:3000); do
            printf '.'
            sleep 5
          done
          echo "Planka listo."

      - name: Run API tests
        env:
          BASE_URI: ${{ env.BASE_URI }}
          USER_EMAIL: ${{ env.USER_EMAIL }}
          USER_PASSWORD: ${{ env.USER_PASSWORD }}
        run: |
          pytest -v tests/ --alluredir=allure-results
